<!DOCTYPE html>
<html lang="ja_jp" dir="ltr">
	<head>
		<title>作業サポート</title>
        <!-- <link rel="icon" href="../resources/images/icon_fgo.png"/> -->
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width">
		<link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
        <!-- 外部样式 -->
		<style>
		#app {margin: -10px 0px 0px -10px;}
		#topMenu {width:100%;height:70px;background-color:#97f2ff}
		.title{color: blueviolet; font-family: system-ui; font-style: oblique; font-weight: bolder; font-size: xx-large;}
        .el-aside{margin:10px 0 0 10px}
        .defLinkIcon > img {width:30px;margin-left:-15px;}
        .defLinkIcon > a {text-decoration: none;color: dimgray;font-size: 18px;}
        .faceImg { border-radius: 50px; width: 50px;border: 2px solid #d9d9dc; background-color: #8a48c7;}
        .el-menu-item.is-active {background-color: aquamarine;}
        .el-submenu__title {padding-left: 5px!important;}
		</style>
		<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
		<script src="resources/common/vue_common.js"></script>
        <script src="resources/common/indexDB.js"></script>
        <script src="resources/data/tableData.json"></script>
        <script src="resources/data/config.json"></script>
		<script type="text/javascript">
		</script>
		<script src="https://unpkg.com/vue@2/dist/vue.js"></script>
		<script src="https://unpkg.com/element-ui/lib/index.js"></script>
        <script>
            const userId = 4//getUrlParam()['id']
        </script>
	</head>
	
	<body>
		<div id="app">
			<div id="topMenu">
				<span class="title">{{title}}</span>
                <div style="position:relative;float:right;top:10px;right:20px">
                <img class="faceImg" src="https://static.wikia.nocookie.net/feheroes_gamepedia_en/images/9/9e/Nerthuz_God_of_the_Land_Face_FC.webp"></img>
                </div>
			</div>
			
            <el-container :style="screenHeight">
			<el-aside :width="asideWidth">
                <el-switch v-model="asideWidthFlag"></el-switch>
                <!-- 权限判断 -->
				<el-menu :default-active="defMenuIndex" class="el-menu-vertical-demo">
					<template v-for="(childMenu,parentNm) in menuList">
                        <el-submenu v-if="parentNm == userInfo.application || 'management' == userInfo.application" :index="parentNm">
                            <template slot="title">
                                <span style="font-size: 25px;">{{appInfo[parentNm]}}</span>
                            </template>
                            <el-menu-item-group>
                                <el-menu-item :index="menu.name" v-for="menu in childMenu">
                                    <el-link v-if="!isWebIcon(menu.icon)" :icon="menu.icon" :href="menu.htmlUrl" target='targetFrame' style="width:100%;text-align:left">{{childMenuName(menu.name)}}</el-link>
                                    <div class="defLinkIcon" v-else>
                                        <img :src="menu.icon"></img>
                                        <a :href="menu.htmlUrl" target='targetFrame' style="width:100%;text-align:left">{{childMenuName(menu.name)}}</a>
                                    </div>
                                </el-menu-item>
                            </el-menu-item-group>
                        </el-submenu>
                    </template>
				</el-menu>
                <el-button @click="transJsonToQuery()">Query</el-button>
			</el-aside>
            
			<el-main style="padding-left: 0px">
				<iframe
				name="targetFrame" 
				style="width:100%;height:100%;margin-right: -20px;float: right;border: none;" 
				border="0"
				:src="defLink"></iframe>
			</el-main>

		</div>
		
		<script>
        var indexDB = new indexDb()
		new Vue({
    	    el: '#app',
    	    data: function() {
    	        return { 
                    myWindow : window,
					menuList : [],
					defMenuIndex : "",
					defLink : "",
                    asideWidthFlag : true,
                    appInfo : application.app,
                    userInfo : {},
                    title : "「文書管理システム」作業サポート"
				}
    	    },
            watch:{
                menuList(newV,oldV) {
                    $.each(newV,(parentNm,menuList)=>{
                        $.each(menuList,(index,menu)=>{
                            if(!isEmpty(menu.defaultLink) && "1"==menu.defaultLink) {
                                this.defMenuIndex = menu.name
                                this.defLink = menu.htmlUrl
                            }
                        })
                    })
                }
            },
			// 編集用データ
			computed: {
                screenHeight : function(){
                    let height = window.screen.height - 190
                    return {"height" : height +"px" }
                },
                asideWidth : function(){
                    return this.asideWidthFlag ? "200px" : "50px"
                },
			},
			// 初期化処理
			mounted() {
                // 登录判断
                if(isEmpty(userId)) {
                    alert("you havn't login yet, please login first!")
                    return
                }
				setTimeout(()=>{
                    let request = indexDB.getData("MENU")
                    request.onsuccess = (event)=>{
                        let data = event.target.result
                        this.transJsonToQuery(data)
                        this.menuList = isEmpty(data) ? groupListByCol(tableData["MENU"],"application") : groupListByCol(data,"application")
                    }
                    
                    let userInfo = indexDB.getData("USER")
                    userInfo.onsuccess = (event)=>{
                        let data = event.target.result
                        let userList = groupListByCol(data,"userId")[userId]
                        if(userList.length > 0) {
                            this.userInfo = userList[0]
                        }
                    }
                },500)
			},
			//
			methods: {
                transJsonToQuery(list){
                    let quary = "INSERT INTO MENU(APPLICATION, LOCATION, NAME, HTML_URL, ICON_URL) VALUES \n"
                    $.each(list,(i,data)=>{
                        let values = "('" + data.application + "', '" + data.location + "', '" + data.name + "', '" + data.htmlUrl + "', '" + data.icon + "')"
                        if(i < list.length - 1) {
                            values += ",\n"
                        } else {
                            values += "\n"
                        }
                        quary += values
                    })
                    console.debug("debug", quary);
                },
                childMenuName : function(name) {
                    let length = name.length
                    for(let i = 0; i < 7-length; i++) {
                        name += "　"
                    }
                    return name
                },
                isWebIcon(icon) {
                    return icon.indexOf("https:") >= 0 ? true : false
                }

			}
    	})
		</script>

	</body>
</html>